<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyVakeel - AI Legal Document Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>MyVakeel</h1>
            <p>Your AI-powered legal document assistant with voice support</p>
            <div id="user-status"></div>
        </div>
        <!-- Add after header, before main-grid -->
        <div class="language-selector-container">
            <div class="language-selector">
                <label for="language-select">üåê Language:</label>
                <select id="language-select" class="language-dropdown" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                    <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                    <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</option>
                    <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                    <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                </select>
            </div>
            
            <!-- Admin Access Button -->
            <button class="admin-access-btn" onclick="showAdminLogin()" title="Admin Access">
                üîß Admin
            </button>
        </div>
        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- File Upload Section -->
            <div class="card">
                <h2 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Document Analysis
                </h2>
                <p>Upload your legal document for AI-powered analysis with voice support</p>
                
                <div class="file-upload" id="file-upload-area">
                    <input type="file" id="file-input" accept=".pdf,image/*,text/*" style="display: none;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="#cbd5e0">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <p>Click to upload or drag & drop</p>
                    <small>PDF, Images, or Text files (Max 10MB)</small>
                </div>
                
                <!-- Progress Container -->
                <div class="progress-container" id="upload-progress" style="display: none;">
                    <div class="progress-header">
                        <div class="progress-title">Processing Document</div>
                        <div class="progress-percentage" id="progress-percent">0%</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-steps" id="progress-steps">
                        <div class="progress-step" id="step-upload">
                            <div class="step-icon pending">1</div>
                            <span>Uploading file to storage</span>
                        </div>
                        <div class="progress-step" id="step-extract">
                            <div class="step-icon pending">2</div>
                            <span>Extracting document content</span>
                        </div>
                        <div class="progress-step" id="step-analyze">
                            <div class="step-icon pending">3</div>
                            <span>AI analysis in progress</span>
                        </div>
                        <div class="progress-step" id="step-complete">
                            <div class="step-icon pending">4</div>
                            <span>Generating insights and summary</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn" id="analyze-file-btn" style="width: 100%; margin-top: 1rem;" disabled>
                    Analyze Document
                </button>
                
                <div class="loading-spinner" id="file-loading"></div>
            </div>

            <!-- Text Analysis Section -->
            <div class="card">
                <h2 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M3,3H21V5H3V3M3,7H15V9H3V7M3,11H21V13H3V11M3,15H15V17H3V15M3,19H21V21H3V19Z"/>
                    </svg>
                    Text Analysis
                </h2>
                <p>Paste text content for quick analysis with voice summary</p>
                
                <textarea class="textarea" id="text-input" placeholder="Paste your legal text, clause, or contract here..." maxlength="50000"></textarea>
                <div style="text-align: right; font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                    <span id="char-count">0</span> / 50,000 characters
                </div>
                
                <button class="btn" id="analyze-text-btn" style="width: 100%; margin-top: 1rem;">
                    Analyze Text
                </button>
                
                <div class="loading-spinner" id="text-loading"></div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="card chat-section">
            <h2 class="card-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,6A2,2 0 0,1 14,8A2,2 0 0,1 12,10A2,2 0 0,1 10,8A2,2 0 0,1 12,6M12,20C10,20 8.4,19.2 7.5,18C8.5,17 10.1,16.5 12,16.5C13.9,16.5 15.5,17 16.5,18C15.6,19.2 14,20 12,20Z"/>
                </svg>
                Legal Assistant Chat
            </h2>
            <p>Ask questions about legal terms, clauses, or get general guidance with voice support</p>
            
            <div class="chat-window" id="chat-window">
                <div class="chat-message bot-message">
                    <p>üëã Hello! I'm MyVakeel, your AI legal assistant. I can help you:</p>
                    <ul style="margin-top: 0.5rem;">
                        <li>üìÑ Explain legal terms and clauses</li>
                        <li>‚öñÔ∏è Provide general legal guidance</li>
                        <li>üìã Summarize articles or documents</li>
                        <li>‚ö†Ô∏è Identify potential risks</li>
                        <li>üé§ Listen to your voice input and read responses aloud</li>
                    </ul>
                    <p style="margin-top: 0.5rem;"><strong>How can I help you today?</strong></p>
                </div>
            </div>
            
            <!-- SINGLE UNIFIED INPUT WITH VOICE -->
            <div class="input-group voice-enabled">
                <input type="text" class="form-input" id="chat-input" placeholder="Ask about legal terms, clauses, or analysis results..." maxlength="500">
                <button class="voice-input-btn" id="voice-input-btn" onclick="toggleVoiceInput()" title="Voice Input">
                    üé§
                </button>
                <button class="btn" id="send-chat-btn">Send</button>
            </div>

            <!-- Voice Input Status -->
            <div class="voice-status" id="voice-status" style="display: none;">
                <div class="voice-indicator">üé§ Listening...</div>
                <div class="voice-text" id="voice-text">Speak now...</div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="results-container">
            <div class="card">
                <h2 class="card-title">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                    </svg>
                    Analysis Results
                </h2>
                
                <!-- Voice Player Section -->
                <div class="voice-player-container" id="voice-player" style="display: none;">
                    <div class="voice-controls">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button class="voice-button" id="play-btn" onclick="playAnalysis()">
                                <span>‚ñ∂Ô∏è</span> Play Analysis
                            </button>
                            <button class="voice-button" id="pause-btn" onclick="pauseAnalysis()" style="display: none;">
                                <span>‚è∏Ô∏è</span> Pause
                            </button>
                            <button class="voice-button" id="stop-btn" onclick="stopAnalysis()">
                                <span>‚èπÔ∏è</span> Stop
                            </button>
                        </div>
                        
                        <div class="voice-settings">
                            <span style="font-size: 0.9rem;">Language:</span>
                            <select class="voice-select" id="voice-language" onchange="changeVoiceLanguage()">
                                <option value="en-US">üá∫üá∏ English (US)</option>
                                <option value="en-GB">üá¨üáß English (UK)</option>
                                <option value="hi-IN">üáÆüá≥ Hindi</option>
                                <option value="es-ES">üá™üá∏ Spanish</option>
                                <option value="fr-FR">üá´üá∑ French</option>
                                <option value="de-DE">üá©üá™ German</option>
                                <option value="ja-JP">üáØüáµ Japanese</option>
                                <option value="zh-CN">üá®üá≥ Chinese</option>
                            </select>
                            
                            <span style="font-size: 0.9rem;">Speed:</span>
                            <input type="range" min="0.5" max="2" step="0.1" value="1" style="width: 80px;" onchange="changePlaybackSpeed(this.value)" id="speed-slider">
                            <span id="speed-display">1x</span>
                        </div>
                    </div>
                    
                    <div class="voice-progress">
                        <div class="voice-progress-bar" id="voice-progress-bar"></div>
                    </div>
                    
                    <div class="voice-info">
                        <span id="voice-current-section">Ready to play analysis</span>
                        <span id="voice-duration">0:00 / 0:00</span>
                    </div>
                    
                    <div class="voice-sections" id="voice-sections">
                        <button class="voice-section-btn" onclick="playSection('summary')">
                            üìã Summary <span style="opacity: 0.7;">(~2 min)</span>
                        </button>
                        <button class="voice-section-btn" onclick="playSection('risks')">
                            ‚ö†Ô∏è Risks <span style="opacity: 0.7;">(~1 min)</span>
                        </button>
                        <button class="voice-section-btn" onclick="playSection('timeline')">
                            üìÖ Timeline <span style="opacity: 0.7;">(~1 min)</span>
                        </button>
                        <button class="voice-section-btn" onclick="playSection('terms')">
                            üîë Key Terms <span style="opacity: 0.7;">(~2 min)</span>
                        </button>
                        <button class="voice-section-btn active" onclick="playSection('all')">
                            üéµ Full Analysis <span style="opacity: 0.7;">(~6 min)</span>
                        </button>
                    </div>
                </div>
                
                <!-- Tabs for different views -->
                <div class="tab-container">
                    <div class="tab active" data-tab="summary">üìã Summary</div>
                    <div class="tab" data-tab="risks">‚ö†Ô∏è Risks</div>
                    <div class="tab" data-tab="timeline">üìÖ Timeline</div>
                    <div class="tab" data-tab="terms">üîë Key Terms</div>
                    <div class="tab" data-tab="visual">üé® Visual</div>
                </div>

                <!-- Tab Contents -->
                <div id="tab-summary" class="tab-content">
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>üìã Document Summary</h3>
                            <div id="summary-content"></div>
                        </div>
                        
                        <div class="result-card">
                            <h3>üìÑ Document Type</h3>
                            <div id="document-type-content"></div>
                        </div>
                        
                        <div class="result-card">
                            <h3>üí° Pro Tip</h3>
                            <div id="tip-content"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-risks" class="tab-content" style="display: none;">
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>‚ö†Ô∏è Identified Risks</h3>
                            <div id="risks-content"></div>
                        </div>
                        
                        <div class="result-card">
                            <h3>üö® Important Clauses</h3>
                            <div id="important-clauses-content"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-timeline" class="tab-content" style="display: none;">
                    <div class="result-card">
                        <h3>üìÖ Important Dates & Timeline</h3>
                        <div id="timeline-content"></div>
                    </div>
                </div>

                <div id="tab-terms" class="tab-content" style="display: none;">
                    <div class="result-card">
                        <h3>üîë Key Terms Explained</h3>
                        <div id="key-terms-content"></div>
                    </div>
                </div>

                <div id="tab-visual" class="tab-content" style="display: none;">
                    <div class="result-card">
                        <h3>üé® Visual Representation</h3>
                        <div class="visual-container" id="visual-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">üîê Login Required</h2>
            <p style="margin-bottom: 1.5rem; color: #666;">Please enter your email to save and access your document analyses.</p>
            
            <div class="input-group" style="flex-direction: column;">
                <input type="email" class="form-input" id="email-input" placeholder="Enter your email address" style="margin-bottom: 1rem;">
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn" id="login-btn" style="flex: 1;">Login</button>
                <button class="btn btn-secondary" id="cancel-login-btn" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    <div class="admin-modal" id="admin-modal">
        <div class="modal-content">
            <h2>üîß Admin Access</h2>
            <div class="admin-form">
                <div class="input-group">
                    <input type="text" id="admin-username" value="admin" class="form-input">
                </div>
                <div class="input-group password-group">
                    <input type="password" id="admin-password" value="123456" class="form-input">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
                </div>
                <div class="modal-buttons">
                    <button class="btn" onclick="adminLogin()">Login</button>
                    <button class="btn btn-secondary" onclick="closeAdminModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Voice Widget -->
    <button class="floating-voice-widget" id="floating-voice" onclick="toggleVoiceWidget()" title="Voice Assistant" style="display: none;">
        üé§
    </button>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let currentUser = null;
        let analysisResults = null;
        let currentUtterance = null;
        let isPlaying = false;
        let currentSection = 'all';
        let speechSynthesis = window.speechSynthesis;
        let currentLanguage = 'en';
        let isListening = false;
        let recognition = null;
        let apiManager=null;
        let languageManager=null;
        let conversationHistory = {};
        let isAdminLoggedIn = false;
        let adminSessionToken = null;
        let adminSessionExpiry = null;
        let fileInput, fileUploadArea, textInput, analyzeFileBtn, analyzeTextBtn;
        let chatInput, sendChatBtn, chatWindow, resultsContainer;
        let loginModal, emailInput, loginBtn, cancelLoginBtn;
        let voicePlayer, floatingVoice;
        const ENHANCED_LANGUAGE_CONFIG = {
            'en': { 
                name: 'English', 
                nativeName: 'English',
                code: 'en-US', 
                voice: 'en-US',
                rtl: false,
                ui: {
                    chatPlaceholder: 'Ask about legal terms, clauses, or analysis results...',
                    analyzeText: 'Analyze Text',
                    analyzeDocument: 'Analyze Document',
                    listening: 'Listening...',
                    voiceNotSupported: 'Voice input not supported in this browser',
                    speakingRate: 'Normal speed'
                }
            },
            'hi': { 
                name: 'Hindi', 
                nativeName: '‡§π‡§ø‡§Ç‡§¶‡•Ä',
                code: 'hi-IN', 
                voice: 'hi-IN',
                rtl: false,
                ui: {
                    chatPlaceholder: '‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç, ‡§ß‡§æ‡§∞‡§æ‡§ì‡§Ç ‡§Ø‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç...',
                    analyzeText: '‡§™‡§æ‡§† ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç',
                    analyzeDocument: '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç',
                    listening: '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à...',
                    voiceNotSupported: '‡§á‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à',
                    speakingRate: '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ó‡§§‡§ø'
                }
            },
            'ta': { 
                name: 'Tamil', 
                nativeName: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç',
                code: 'ta-IN', 
                voice: 'ta-IN',
                rtl: false,
                ui: {
                    chatPlaceholder: '‡Æö‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æ§‡Æø‡ÆÆ‡ØÅ‡Æ±‡Øà‡Æï‡Æ≥‡Øç, ‡Æ™‡Æø‡Æ∞‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...',
                    analyzeText: '‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',
                    analyzeDocument: '‡ÆÜ‡Æµ‡Æ£‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',
                    listening: '‡Æï‡Øá‡Æü‡Øç‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Øä‡Æ£‡Øç‡Æü‡Æø‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...',
                    voiceNotSupported: '‡Æá‡Æ®‡Øç‡Æ§ ‡Æâ‡Æ≤‡Ææ‡Æµ‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÄ‡Æü‡ØÅ ‡ÆÜ‡Æ§‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà',
                    speakingRate: '‡Æö‡Ææ‡Æ§‡Ææ‡Æ∞‡Æ£ ‡Æµ‡Øá‡Æï‡ÆÆ‡Øç'
                }
            },
            'te': { 
                name: 'Telugu', 
                nativeName: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å',
                code: 'te-IN', 
                voice: 'te-IN',
                rtl: false,
                ui: {
                    chatPlaceholder: '‡∞ö‡∞ü‡±ç‡∞ü‡∞™‡∞∞‡∞Æ‡±à‡∞® ‡∞®‡∞ø‡∞¨‡∞Ç‡∞ß‡∞®‡∞≤‡±Å, ‡∞®‡∞ø‡∞¨‡∞Ç‡∞ß‡∞®‡∞≤‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø...',
                    analyzeText: '‡∞µ‡∞ö‡∞®‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
                    analyzeDocument: '‡∞™‡∞§‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
                    listening: '‡∞µ‡∞ø‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞¶‡∞ø...',
                    voiceNotSupported: '‡∞à ‡∞¨‡±ç‡∞∞‡±å‡∞ú‡∞∞‡±ç‚Äå‡∞≤‡±ã ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç ‡∞Æ‡∞¶‡±ç‡∞¶‡∞§‡±Å ‡∞≤‡±á‡∞¶‡±Å',
                    speakingRate: '‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞µ‡±á‡∞ó‡∞Ç'
                }
            }
            // Add other languages following the same pattern...
        };
        const SUPPORTED_LANGUAGES = ENHANCED_LANGUAGE_CONFIG;
        // === UNIFIED LANGUAGE MANAGER ===
        class LanguageManager {
            constructor() {
                this.currentLanguage = 'en';
                this.callbacks = [];
                this.initializeFromStorage();
            }
            
            initializeFromStorage() {
                const saved = localStorage.getItem('myvakeel_language');
                if (saved && ENHANCED_LANGUAGE_CONFIG[saved]) {
                    this.currentLanguage = saved;
                }
                this.updateAllLanguageSettings();
            }
            
            changeLanguage(langCode) {
                if (!ENHANCED_LANGUAGE_CONFIG[langCode]) {
                    console.error(`Language ${langCode} not supported`);
                    return false;
                }
                
                this.currentLanguage = langCode;
                localStorage.setItem('myvakeel_language', langCode);
                
                this.updateAllLanguageSettings();
                this.notifyCallbacks(langCode);
                
                showNotification(`Language changed to ${ENHANCED_LANGUAGE_CONFIG[langCode].nativeName}`, 'success');
                return true;
            }
            
            updateAllLanguageSettings() {
                const config = ENHANCED_LANGUAGE_CONFIG[this.currentLanguage];
                
                // Update UI elements
                this.updateUIElements(config);
                
                // Update voice synthesis
                this.updateVoiceSettings(config);
                
                // Update speech recognition
                this.updateSpeechRecognition(config);
                
                // Update HTML lang attribute
                document.documentElement.lang = config.code.split('-')[0];
                
                // Update text direction for RTL languages
                document.body.dir = config.rtl ? 'rtl' : 'ltr';
            }
            
            updateUIElements(config) {
                const elements = {
                    'chat-input': 'placeholder',
                    'text-input': 'placeholder'
                };
                
                Object.entries(elements).forEach(([id, attr]) => {
                    const element = document.getElementById(id);
                    if (element && config.ui.chatPlaceholder) {
                        element[attr] = config.ui.chatPlaceholder;
                    }
                });
                
                // Update button texts
                const analyzeTextBtn = document.getElementById('analyze-text-btn');
                const analyzeFileBtn = document.getElementById('analyze-file-btn');
                
                if (analyzeTextBtn && !analyzeTextBtn.disabled) {
                    analyzeTextBtn.textContent = config.ui.analyzeText;
                }
                
                if (analyzeFileBtn && !analyzeFileBtn.disabled) {
                    analyzeFileBtn.textContent = config.ui.analyzeDocument;
                }
                
                // Update language selector
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    languageSelect.value = this.currentLanguage;
                }
            }
            
            updateVoiceSettings(config) {
                const voiceLanguageSelect = document.getElementById('voice-language');
                if (voiceLanguageSelect) {
                    // Map to closest available voice
                    const voiceMappings = {
                        'en': 'en-US',
                        'hi': 'hi-IN',
                        'ta': 'ta-IN',
                        'te': 'te-IN',
                        'bn': 'bn-IN',
                        'mr': 'mr-IN',
                        'gu': 'gu-IN',
                        'kn': 'kn-IN'
                    };
                    
                    const voiceCode = voiceMappings[this.currentLanguage] || 'en-US';
                    voiceLanguageSelect.value = voiceCode;
                }
            }
            
            updateSpeechRecognition(config) {
                if (recognition) {
                    recognition.lang = config.code;
                }
            }
            
            getCurrentConfig() {
                return ENHANCED_LANGUAGE_CONFIG[this.currentLanguage];
            }
            
            onLanguageChange(callback) {
                this.callbacks.push(callback);
            }
            
            notifyCallbacks(langCode) {
                this.callbacks.forEach(callback => {
                    try {
                        callback(langCode, ENHANCED_LANGUAGE_CONFIG[langCode]);
                    } catch (error) {
                        console.error('Language callback error:', error);
                    }
                });
            }
        }
        // === API MANAGER (fixed FormData handling + tolerant JSON parsing) ===
        class APIManager {
            constructor() {
                this.baseURL = this.detectBaseURL();
                this.retryAttempts = 2;
                this.retryDelay = 1000; // 1 second
            }

            detectBaseURL() {
                const { protocol, hostname, port } = window.location;
                if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('192.168.')) {
                    // If you open frontend via a file:// URL, default to 5000
                    return `${protocol}//${hostname}:${port || 5000}`;
                }
                return window.location.origin;
            }

            async makeRequest(endpoint, options = {}) {
                const url = `${this.baseURL}/api${endpoint.startsWith('/') ? endpoint : '/' + endpoint}`;

                // Default headers; we'll remove Content-Type if sending FormData
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                                ...options.headers
                            }
                        };

                // Merge but do not mutate original
                const finalOptions = { ...defaultOptions, ...options };
                finalOptions.headers = { ...(defaultOptions.headers || {}), ...(options.headers || {}) };

                // If `body` is FormData, delete Content-Type so the browser sets multipart boundary correctly
                if (finalOptions.body instanceof FormData) {
                    delete finalOptions.headers['Content-Type'];
                }

                for (let attempt = 0; attempt <= this.retryAttempts; attempt++) {
                    try {
                        const response = await fetch(url, finalOptions);

                        // Try to parse JSON if possible, but tolerate non-JSON responses
                        const contentType = response.headers.get('content-type') || '';
                        let payload = null;
                        if (contentType.includes('application/json')) {
                            payload = await response.json().catch(() => null);
                        } else {
                            // try text fallback
                            const text = await response.text().catch(() => null);
                            // if text looks like JSON try to parse
                            try { payload = text ? JSON.parse(text) : null; } catch { payload = text; }
                        }

                        if (!response.ok) {
                            const errMsg = (payload && payload.error) ? payload.error : `Server error ${response.status}`;
                            // Wrap as APIError so caller can handle status codes
                            throw new APIError(errMsg, response.status, payload);
                        }

                        return payload;
                    } catch (error) {
                        // Don't retry on client errors (4xx)
                        if (error instanceof APIError && error.status >= 400 && error.status < 500) {
                            throw error;
                        }
                        if (attempt === this.retryAttempts) throw error;
                        // exponential backoff
                        await this.sleep(this.retryDelay * (attempt + 1));
                    }
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        
        // Custom API Error class
        class APIError extends Error {
            constructor(message, status, data) {
                super(message);
                this.name = 'APIError';
                this.status = status;
                this.data = data;
            }
        }
        
        class ConnectionMonitor {
            constructor() {
                this.isOnline = navigator.onLine;
                this.quality = 'unknown';
                this.setupEventListeners();
                this.startMonitoring();
            }
            
            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    showNotification('Connection restored', 'success');
                    this.updateConnectionIndicator();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    showNotification('Connection lost - some features may not work', 'warning');
                    this.updateConnectionIndicator();
                });
            }
            
            async startMonitoring() {
                setInterval(async () => {
                    if (this.isOnline) {
                        await this.checkConnectionQuality();
                    }
                }, 30000); // Check every 30 seconds
            }
            
            async checkConnectionQuality() {
                const start = performance.now();
                try {
                    await checkHealthAPI();
                    const duration = performance.now() - start;
                    
                    if (duration < 500) {
                        this.quality = 'excellent';
                    } else if (duration < 1000) {
                        this.quality = 'good';
                    } else if (duration < 2000) {
                        this.quality = 'fair';
                    } else {
                        this.quality = 'poor';
                    }
                } catch (error) {
                    this.quality = 'offline';
                }
                
                this.updateConnectionIndicator();
            }
            
            updateConnectionIndicator() {
                const indicator = document.querySelector('.connection-indicator');
                if (indicator) {
                    const colors = {
                        excellent: '#10b981',
                        good: '#34d399',
                        fair: '#fbbf24',
                        poor: '#f87171',
                        offline: '#ef4444'
                    };
                    
                    indicator.style.background = colors[this.quality] || '#6b7280';
                    indicator.title = `Connection: ${this.quality}`;
                }
            }
        }

        // DOM elements
        
       
        const ERROR_MESSAGES = {
            'network_error': {
                title: 'Connection Problem',
                message: 'Cannot connect to the server. Please check your internet connection.',
                suggestions: [
                    'Check if your internet is working',
                    'Try refreshing the page',
                    'Contact support if the problem continues'
                ]
            },
            'server_error': {
                title: 'Server Issue',
                message: 'Our servers are having trouble processing your request.',
                suggestions: [
                    'Please try again in a few moments',
                    'Try a smaller file if uploading',
                    'Contact support if the issue persists'
                ]
            },
            'file_too_large': {
                title: 'File Too Big',
                message: 'Your file is larger than our 10MB limit.',
                suggestions: [
                    'Try compressing your PDF file',
                    'Split large documents into smaller parts',
                    'Use the text analysis feature instead'
                ]
            },
            'invalid_file': {
                title: 'File Not Supported',
                message: 'We can only analyze PDF files, images (JPG, PNG), and text files.',
                suggestions: [
                    'Convert your document to PDF format',
                    'Take a clear photo of paper documents',
                    'Copy and paste text into the text analyzer'
                ]
            },
            'login_required': {
                title: 'Login Required',
                message: 'Please log in with your email to analyze documents.',
                suggestions: [
                    'Click the login button and enter your email',
                    'Your analysis will be saved for future reference',
                    'You can still use the chat feature without logging in'
                ]
            },
            'analysis_failed': {
                title: 'Analysis Failed',
                message: 'We couldn\'t analyze your document. This might be due to unclear text or unsupported content.',
                suggestions: [
                    'Try uploading a clearer scan of the document',
                    'Make sure the document contains readable text',
                    'Contact support with the document type you\'re trying to analyze'
                ]
            }
        };
        const errorStyles = document.createElement('style');
        errorStyles.textContent = `
            @keyframes slideInDown {
                from { opacity: 0; transform: translateY(-30px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes slideOutUp {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-30px); }
            }
            .enhanced-error-container .error-header {
                display: flex; align-items: center; justify-content: space-between;
                margin-bottom: 1rem; font-weight: bold; color: #dc2626;
            }
            .enhanced-error-container .error-icon {
                background: #dc2626; color: white; width: 30px; height: 30px;
                border-radius: 50%; display: flex; align-items: center; justify-content: center;
            }
            .enhanced-error-container .error-close {
                background: none; border: none; font-size: 1.5rem; cursor: pointer;
                color: #666; padding: 0; width: 30px; height: 30px;
            }
            .enhanced-error-container .error-actions {
                display: flex; gap: 1rem; margin-top: 1rem;
            }
        `;
        document.head.appendChild(errorStyles);
        // Initialize app
        // Replace all your separate DOMContentLoaded listeners with this single one:
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing MyVakeel...');
            
            // Initialize DOM elements first
            fileInput = document.getElementById('file-input');
            fileUploadArea = document.getElementById('file-upload-area');
            textInput = document.getElementById('text-input');
            analyzeFileBtn = document.getElementById('analyze-file-btn');
            analyzeTextBtn = document.getElementById('analyze-text-btn');
            chatInput = document.getElementById('chat-input');
            sendChatBtn = document.getElementById('send-chat-btn');
            chatWindow = document.getElementById('chat-window');
            resultsContainer = document.getElementById('results-container');
            
            // Initialize managers
            apiManager = new APIManager();
            languageManager = new LanguageManager();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize other features
            initializeSpeechRecognition();
            checkUserSession();
            updateUserStatus();
            checkServerStatus();
            setupCharacterCounter();
            
            console.log('‚úÖ MyVakeel initialized successfully!');
        });

        languageManager.onLanguageChange((langCode, config) => {
            // Update speech recognition immediately
            if (recognition && recognition.lang !== config.code) {
                recognition.lang = config.code;
                
                // Restart if currently listening
                if (isListening) {
                    stopVoiceInput();
                    setTimeout(startVoiceInput, 300);
                }
            }
            
            // Update voice status text
            const voiceStatus = document.getElementById('voice-status');
            if (voiceStatus && voiceStatus.style.display !== 'none') {
                document.getElementById('voice-text').textContent = config.ui.listening;
            }
        });

        async function registerUser(email) {
            return await apiManager.makeRequest('/register', {
                method: 'POST',
                body: JSON.stringify({ email })
            });
        }

        async function analyzeFileAPI(file, userEmail) {
            const formData = new FormData();
            formData.append('file', file);
            if (userEmail) formData.append('user_email', userEmail);

            return await apiManager.makeRequest('/analyze-file', {
                method: 'POST',
                // Do not set Content-Type here; APIManager will remove it if it's FormData.
                headers: {
                    'User-Email': userEmail || ''
                },
                body: formData
            });
        }

        async function analyzeTextAPI(text, userEmail = '') {
            return await apiManager.makeRequest('/analyze-text', {
                method: 'POST',
                headers: {
                    'User-Email': userEmail
                },
                body: JSON.stringify({ text })
            });
        }

        async function sendChatAPI(query, language = 'en') {
            return await apiManager.makeRequest('/chat', {
                method: 'POST',
                body: JSON.stringify({ query, language })
            });
        }

        async function checkHealthAPI() {
            return await apiManager.makeRequest('/health');
        }

        async function getUserHistory(email) {
            return await apiManager.makeRequest(`/user-history/${email}`);
        }

        // === UPDATED LANGUAGE CHANGE FUNCTION ===
        function changeLanguage() {
            const selectedLang = document.getElementById('language-select').value;
            languageManager.changeLanguage(selectedLang);
        }
        function testChatButton() {
            console.log('üß™ Testing chat button...');
            console.log('Send button exists:', !!sendChatBtn);
            console.log('Chat input exists:', !!chatInput);
            console.log('Chat input value:', chatInput ? chatInput.value : 'N/A');
            
            if (sendChatBtn && chatInput && chatWindow) {
                console.log('Chat input value before:', chatInput.value);
                chatInput.value = 'Hello, this is a test message';
                console.log('Chat input value after:', chatInput.value);
                handleChatMessage();
            } else {
                console.error('‚ùå Missing required elements for chat');
                console.log('Available elements:');
                console.log('- sendChatBtn:', sendChatBtn);
                console.log('- chatInput:', chatInput);  
                console.log('- chatWindow:', chatWindow);
            }
        }
        // === UPDATED VOICE LANGUAGE CHANGE ===
        function changeVoiceLanguage() {
            const voiceSelect = document.getElementById('voice-language');
            if (!voiceSelect) return;
            
            const selectedVoice = voiceSelect.value;
            
            // Find matching language for UI
            const matchingLang = Object.entries(ENHANCED_LANGUAGE_CONFIG).find(([code, config]) => 
                config.voice === selectedVoice || selectedVoice.startsWith(code)
            );
            
            if (matchingLang && matchingLang[0] !== languageManager.currentLanguage) {
                // Sync UI language with voice
                const languageSelect = document.getElementById('language-select');
                if (languageSelect) {
                    languageSelect.value = matchingLang[0];
                    languageManager.changeLanguage(matchingLang[0]);
                }
            }
            
            // Restart current playback with new language if playing
            if (isPlaying) {
                stopAnalysis();
                setTimeout(() => playSection(currentSection, selectedVoice), 100);
            }
        }

        // === LANGUAGE DETECTION FROM ANALYSIS ===
        function detectContentLanguage(analysisData) {
            if (!analysisData) return 'en';
            
            const textContent = JSON.stringify(analysisData).toLowerCase();
            const patterns = {
                'hi': /[\u0900-\u097F]|hindi|‡§π‡§ø‡§Ç‡§¶‡•Ä/,
                'ta': /[\u0B80-\u0BFF]|tamil|‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç/,
                'te': /[\u0C00-\u0C7F]|telugu|‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å/,
                'bn': /[\u0980-\u09FF]|bengali|‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ/,
                'mr': /[\u0900-\u097F]|marathi|‡§Æ‡§∞‡§æ‡§†‡•Ä/,
                'gu': /[\u0A80-\u0AFF]|gujarati|‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä/,
                'kn': /[\u0C80-\u0CFF]|kannada|‡≤ï‡≤®‡≥ç‡≤®‡≤°/
            };
            
            for (const [lang, pattern] of Object.entries(patterns)) {
                if (pattern.test(textContent)) {
                    return lang;
                }
            }
            
            return 'en';
        }

        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function createSafeElement(tag, content, className = '') {
            const element = document.createElement(tag);
            element.textContent = content; // Use textContent instead of innerHTML
            if (className) element.className = className;
            return element;
        }

        function safeSetHTML(element, content) {
            // Only allow basic markdown-like formatting
            const safeContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **bold**
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // *italic*
                .replace(/`(.*?)`/g, '<code>$1</code>') // `code`
                .replace(/\n/g, '<br>'); // newlines
            
            element.innerHTML = safeContent;
        }

        function setupEventListeners() {
            // File upload events
            console.log('üéØ Setting up all event listeners...');
            try {
                // File upload events
                if (fileUploadArea && fileInput) {
                    fileUploadArea.addEventListener('click', () => fileInput.click());
                    fileUploadArea.addEventListener('dragover', handleDragOver);
                    fileUploadArea.addEventListener('dragleave', handleDragLeave);
                    fileUploadArea.addEventListener('drop', handleFileDrop);
                    fileInput.addEventListener('change', handleFileSelect);
                }
                
                if (analyzeFileBtn) {
                    analyzeFileBtn.addEventListener('click', analyzeFile);
                }

                // Text analysis events
                if (analyzeTextBtn) {
                    analyzeTextBtn.addEventListener('click', analyzeText);
                }

                // Chat events - FIXED NAMING
                if (sendChatBtn) {
                    sendChatBtn.addEventListener('click', handleChatMessage);
                    console.log('‚úÖ Chat send button event listener added');
                } else {
                    console.error('‚ùå Send chat button not found!');
                }
                
                if (chatInput) {
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Prevent form submission
                            handleChatMessage();
                        }
                    });
                    console.log('‚úÖ Chat input enter key listener added');
                } else {
                    console.error('‚ùå Chat input not found!');
                }

                // Login events
                if (loginBtn && cancelLoginBtn && emailInput) {
                    loginBtn.addEventListener('click', handleLogin);
                    cancelLoginBtn.addEventListener('click', closeLoginModal);
                }

                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                });

                // Speech synthesis events
                /* if (speechSynthesis) {
                    speechSynthesis.addEventListener('voiceschanged', updateVoiceOptions);
                } */
                
                console.log('‚úÖ All event listeners set up successfully');
                
            } catch (error) {
                console.error('‚ùå Error setting up event listeners:', error);
            }
        }


        // Character counter for text input
        function setupCharacterCounter() {
            const charCount = document.getElementById('char-count');
            textInput.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                
                if (count > 45000) {
                    charCount.style.color = '#dc2626';
                } else if (count > 40000) {
                    charCount.style.color = '#d97706';
                } else {
                    charCount.style.color = '#6b7280';
                }
            });
        }

        // Speech synthesis support check
        function checkSpeechSynthesisSupport() {
            if (!speechSynthesis) {
                console.warn('Speech synthesis not supported in this browser');
                return false;
            }
            
            // Test if voices are available
            const voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                // Voices might not be loaded yet, try again after a delay
                setTimeout(() => {
                    const voicesRetry = speechSynthesis.getVoices();
                    if (voicesRetry.length === 0) {
                        console.warn('No voices available for speech synthesis');
                    } else {
                        updateVoiceOptions();
                    }
                }, 1000);
            } else {
                updateVoiceOptions();
            }
            
            return true;
        }

        function updateVoiceOptions() {
            const voices = speechSynthesis.getVoices();
            const languageSelect = document.getElementById('voice-language');
            
            // Keep current selection
            const currentSelection = languageSelect.value;
            
            // Clear and rebuild options based on available voices
            const availableLanguages = new Set();
            voices.forEach(voice => {
                const langCode = voice.lang.toLowerCase();
                if (langCode.startsWith('en')) {
                    availableLanguages.add('en-US');
                    availableLanguages.add('en-GB');
                } else if (langCode.startsWith('hi')) {
                    availableLanguages.add('hi-IN');
                } else if (langCode.startsWith('es')) {
                    availableLanguages.add('es-ES');
                } else if (langCode.startsWith('fr')) {
                    availableLanguages.add('fr-FR');
                } else if (langCode.startsWith('de')) {
                    availableLanguages.add('de-DE');
                } else if (langCode.startsWith('ja')) {
                    availableLanguages.add('ja-JP');
                } else if (langCode.startsWith('zh')) {
                    availableLanguages.add('zh-CN');
                }
            });

            // Restore selection if still available
            if (availableLanguages.has(currentSelection)) {
                languageSelect.value = currentSelection;
            }

            console.log(`Voice synthesis ready with ${voices.length} voices in ${availableLanguages.size} languages`);
        }

        // Server status checker
        async function checkServerStatus() {
            try {
                const data = await checkHealthAPI();
                
                if (data.status === 'healthy') {
                    console.log('‚úÖ Server is running properly');
                    addServerIndicator('online');
                } else {
                    console.warn('‚ö†Ô∏è Server health check failed');
                    addServerIndicator('warning');
                }
            } catch (error) {
                console.error('‚ùå Server connection failed:', error);
                
                let message = 'Server connection failed.';
                if (error instanceof APIError) {
                    message += ` Status: ${error.status}`;
                } else {
                    message += ' Please start Flask app on the correct port.';
                }
                
                showNotification(message, 'error');
                addServerIndicator('offline');
            }
        }

        function addServerIndicator(status) {
            // Remove existing indicator
            const existing = document.querySelector('.server-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'server-indicator';
            indicator.style.cssText = `
                position: fixed; top: 10px; left: 10px; 
                width: 12px; height: 12px; 
                border-radius: 50%; 
                z-index: 1000;
                transition: all 0.3s ease;
            `;

            const colors = {
                online: '#10b981',
                warning: '#d97706', 
                offline: '#dc2626'
            };

            const titles = {
                online: 'Server Online',
                warning: 'Server Warning',
                offline: 'Server Offline'
            };

            indicator.style.background = colors[status];
            indicator.title = titles[status];
            
            if (status === 'online') {
                indicator.style.boxShadow = `0 0 8px ${colors[status]}40`;
            }

            document.body.appendChild(indicator);
        }

        // File handling functions
        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                // Validate file size
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`File too large: ${sizeMB}MB. Maximum size is 10MB.`, 'error');
                    fileInput.value = '';
                    return;
                }

                analyzeFileBtn.disabled = false;
                fileUploadArea.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="#10b981">
                        <path d="M9,16.17L4.83,12L3.41,13.41L9,19L21,7L19.59,5.59L9,16.17Z"/>
                    </svg>
                    <p><strong>File selected:</strong> ${file.name}</p>
                    <small>Size: ${sizeMB} MB ‚Ä¢ Type: ${file.type}</small>
                `;
            }
        }

        // Authentication functions
        function checkUserSession() {
            const savedUser = localStorage.getItem('myvakeel_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserStatus();
            }
        }

        function updateUserStatus() {
            const userStatus = document.getElementById('user-status');
            if (currentUser) {
                userStatus.innerHTML = `
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; display: inline-block;">
                        ‚úÖ Logged in as: ${currentUser.email}
                        <button onclick="logout()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer; text-decoration: underline;">Logout</button>
                    </div>
                `;
            } else {
                userStatus.innerHTML = `
                    <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; display: inline-block;">
                        üí¨ Chat available without login | üìÑ Login required for document analysis
                    </div>
                `;
            }
        }

        function showLoginModal() {
            loginModal.style.display = 'block';
        }

        function closeLoginModal() {
            loginModal.style.display = 'none';
        }

        async function handleLogin() {
            const email = emailInput.value.trim();
            if (!email) {
                showEnhancedError('login_required', 'Please enter your email address');
                return;
            }

            if (!isValidEmail(email)) {
                showEnhancedError('login_required', 'Please enter a valid email address');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try {
                const data = await registerUser(email);
                
                if (data.success) {
                    currentUser = { email: data.email };
                    localStorage.setItem('myvakeel_user', JSON.stringify(currentUser));
                    updateUserStatus();
                    closeLoginModal();
                    showNotification('Successfully logged in!', 'success');
                    
                    if (fileInput.files.length > 0) {
                        analyzeFile();
                    }
                } else {
                    showEnhancedError('login_required', data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                
                if (error instanceof APIError) {
                    if (error.status >= 500) {
                        showEnhancedError('server_error', error.message);
                    } else {
                        showEnhancedError('login_required', error.message);
                    }
                } else {
                    showEnhancedError('network_error', error.message);
                }
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }


        function logout() {
            currentUser = null;
            localStorage.removeItem('myvakeel_user');
            updateUserStatus();
            showNotification('Logged out successfully', 'success');
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Enhanced Analysis functions
        async function analyzeFile() {
            if (!currentUser) {
                showEnhancedError('login_required');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                showNotification('Please select a file', 'error');
                return;
            }

            // Check file size
            if (file.size > 10 * 1024 * 1024) {
                showEnhancedError('file_too_large', `File size: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                return;
            }

            // Check file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg', 'text/plain'];
            if (!allowedTypes.includes(file.type)) {
                showEnhancedError('invalid_file', `File type: ${file.type}`);
                return;
            }

            showUploadProgress();
            analyzeFileBtn.disabled = true;
            analyzeFileBtn.textContent = 'Analyzing...';

            try {
                const data = await analyzeFileAPI(file, currentUser.email);
                
                if (data.success) {
                    analysisResults = data.result;
                    displayEnhancedResults(data.result);
                    showNotification(`Document analyzed successfully! (${data.file_size})`, 'success');
                } else {
                    const errorType = detectErrorType(new Error(data.error));
                    showEnhancedError(errorType, data.details);
                }
            } catch (error) {
                console.error('File analysis error:', error);
                
                if (error instanceof APIError) {
                    if (error.status === 413) {
                        showEnhancedError('file_too_large', error.message);
                    } else if (error.status === 415) {
                        showEnhancedError('invalid_file', error.message);
                    } else if (error.status >= 500) {
                        showEnhancedError('server_error', error.message);
                    } else {
                        showEnhancedError('analysis_failed', error.message);
                    }
                } else {
                    showEnhancedError('network_error', error.message);
                }
            } finally {
                hideUploadProgress();
                analyzeFileBtn.disabled = false;
                analyzeFileBtn.textContent = 'Analyze Document';
            }
        }

        async function analyzeText() {
            const text = textInput.value.trim();
            if (!text) {
                showNotification('Please enter some text to analyze', 'error');
                return;
            }

            if (text.length > 50000) {
                showEnhancedError('analysis_failed', `Text too long: ${text.length} characters (max: 50,000)`);
                return;
            }

            showLoading('text-loading', true);
            analyzeTextBtn.disabled = true;
            analyzeTextBtn.textContent = 'Analyzing...';

            try {
                const data = await analyzeTextAPI(text, currentUser ? currentUser.email : '');
                
                if (data.success) {
                    analysisResults = data.result;
                    displayEnhancedResults(data.result);
                    showNotification(`Text analyzed successfully! (${data.text_length} characters)`, 'success');
                } else {
                    const errorType = detectErrorType(new Error(data.error));
                    showEnhancedError(errorType, data.details);
                }
            } catch (error) {
                console.error('Text analysis error:', error);
                
                if (error instanceof APIError) {
                    if (error.status >= 500) {
                        showEnhancedError('server_error', error.message);
                    } else {
                        showEnhancedError('analysis_failed', error.message);
                    }
                } else {
                    showEnhancedError('network_error', error.message);
                }
            } finally {
                showLoading('text-loading', false);
                analyzeTextBtn.disabled = false;
                analyzeTextBtn.textContent = 'Analyze Text';
            }
        }
        // Progress tracking functions
        function showUploadProgress() {
            const progressContainer = document.getElementById('upload-progress');
            progressContainer.style.display = 'block';
            
            // Simulate progress steps
            setTimeout(() => updateProgressStep('upload', 25), 500);
            setTimeout(() => updateProgressStep('extract', 50), 1500);
            setTimeout(() => updateProgressStep('analyze', 75), 3000);
        }

        function updateProgressStep(stepId, percentage) {
            const step = document.getElementById(`step-${stepId}`);
            const icon = step.querySelector('.step-icon');
            const progressFill = document.getElementById('progress-fill');
            const progressPercent = document.getElementById('progress-percent');
            
            // Update previous steps to completed
            const steps = ['upload', 'extract', 'analyze', 'complete'];
            const currentIndex = steps.indexOf(stepId);
            
            for (let i = 0; i <= currentIndex; i++) {
                const stepElement = document.getElementById(`step-${steps[i]}`);
                const stepIcon = stepElement.querySelector('.step-icon');
                stepElement.classList.remove('pending');
                stepElement.classList.add('completed');
                stepIcon.classList.remove('pending');
                stepIcon.classList.add('completed');
                stepIcon.textContent = '‚úì';
            }
            
            // Update current step
            if (currentIndex < steps.length - 1) {
                const nextStep = document.getElementById(`step-${steps[currentIndex + 1]}`);
                const nextIcon = nextStep.querySelector('.step-icon');
                nextStep.classList.add('active');
                nextIcon.classList.remove('pending');
                nextIcon.classList.add('active');
            }
            
            progressFill.style.width = percentage + '%';
            progressPercent.textContent = percentage + '%';
        }

        function hideUploadProgress() {
            setTimeout(() => {
                const progressContainer = document.getElementById('upload-progress');
                progressContainer.style.display = 'none';
                
                // Reset all steps
                const steps = ['upload', 'extract', 'analyze', 'complete'];
                steps.forEach(stepId => {
                    const step = document.getElementById(`step-${stepId}`);
                    const icon = step.querySelector('.step-icon');
                    step.className = 'progress-step';
                    icon.className = 'step-icon pending';
                    icon.textContent = steps.indexOf(stepId) + 1;
                });
                
                document.getElementById('progress-fill').style.width = '0%';
                document.getElementById('progress-percent').textContent = '0%';
            }, 1000);
        }

        function showAnalysisError(errorData) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'error-container';
            errorContainer.innerHTML = `
                <div class="error-header">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-title">${errorData.error || 'Analysis Failed'}</div>
                </div>
                <div class="error-message">
                    ${errorData.details || 'An unexpected error occurred during analysis.'}
                </div>
                ${errorData.suggestion ? `
                    <div class="error-suggestions">
                        <h4>üí° Suggestions:</h4>
                        <p>${errorData.suggestion}</p>
                        ${errorData.supported_types ? `
                            <p><strong>Supported formats:</strong> ${errorData.supported_types.join(', ')}</p>
                        ` : ''}
                    </div>
                ` : ''}
                <div class="error-actions">
                    <button class="btn" onclick="this.parentElement.parentElement.remove()">Try Again</button>
                    <button class="btn btn-secondary" onclick="showSupportInfo()">Get Help</button>
                </div>
            `;
            
            // Insert after file upload area
            fileUploadArea.parentNode.insertBefore(errorContainer, fileUploadArea.nextSibling);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorContainer.parentNode) {
                    errorContainer.remove();
                }
            }, 10000);
        }

        function showSupportInfo() {
            alert('üõ†Ô∏è Need Help?\n\n‚Ä¢ Make sure your Flask server is running on http://localhost:5000\n‚Ä¢ Check that your API_KEY is properly configured\n‚Ä¢ Try uploading a smaller or different format file\n‚Ä¢ Use the text analysis feature as an alternative\n\nFor more help, check the console for detailed error messages.');
        }

        // Enhanced Chat functions
        async function handleChatMessage() {
            const query = chatInput.value.trim();
            if (!query) return;

            addMessageToChat(query, 'user');
            chatInput.value = '';

            const thinkingMessage = addMessageToChat('ü§î MyVakeel is thinking...', 'bot', true);
            sendChatBtn.disabled = true;

            try {
                const data = await sendChatAPI(query, languageManager.currentLanguage);
                
                thinkingMessage.remove();
                
                if (data.response) {
                    const botMessage = addMessageToChat(data.response, 'bot');
                    
                    // Add voice playback button for chat responses
                    if (speechSynthesis) {
                        const voiceBtn = document.createElement('button');
                        voiceBtn.className = 'voice-button';
                        voiceBtn.style.cssText = 'margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8rem;';
                        voiceBtn.innerHTML = 'üîä Play Response';
                        voiceBtn.onclick = () => speakText(data.response);
                        botMessage.appendChild(voiceBtn);
                    }
                } else {
                    addMessageToChat('Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                thinkingMessage.remove();
                console.error('Chat error:', error);
                
                let errorMessage = '‚ùå ';
                if (error instanceof APIError) {
                    if (error.status >= 500) {
                        errorMessage += 'Our chat service is temporarily unavailable. Please try again.';
                    } else {
                        errorMessage += 'Sorry, I encountered an error. Please try again.';
                    }
                } else {
                    errorMessage += 'Cannot connect to chat service. Please check your internet connection.';
                }
                
                addMessageToChat(errorMessage, 'bot');
            } finally {
                sendChatBtn.disabled = false;
            }
        }
                   
        function setupMobileOptimizations() {
            const voiceBtn = document.getElementById('voice-input-btn');
            if (voiceBtn) {
                // Add touch feedback
                voiceBtn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                voiceBtn.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                });
                
                // Prevent double-tap zoom on voice button
                let lastTouchEnd = 0;
                voiceBtn.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // Optimize chat input for mobile
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                // Prevent viewport zoom on input focus
                chatInput.addEventListener('focus', function() {
                    if (window.innerWidth < 768) {
                        this.style.fontSize = '16px'; // Prevents zoom on iOS
                    }
                });
                
                chatInput.addEventListener('blur', function() {
                    this.style.fontSize = '';
                });
            }
        }

        function addMessageToChat(message, sender, isTemporary = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            // Create paragraph element safely
            const paragraph = document.createElement('p');
            
            if (sender === 'bot' && message.includes('**')) {
                // For bot messages, allow basic formatting
                safeSetHTML(paragraph, message);
            } else {
                // For user messages, use plain text
                paragraph.textContent = message;
            }
            
            messageDiv.appendChild(paragraph);
            
            if (isTemporary) {
                messageDiv.style.opacity = '0.7';
                messageDiv.classList.add('thinking');
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            return messageDiv;
        }

        // Enhanced Results display functions
        function displayEnhancedResults(results) {
            resultsContainer.style.display = 'block';
            voicePlayer.style.display = 'block';
            floatingVoice.style.display = 'block';
            
            // Display enhanced summary
            if (results.summary) {
                displayEnhancedSummary(results.summary);
            }

            // Display document type
            if (results.document_type) {
                const docTypeContent = document.getElementById('document-type-content');
                docTypeContent.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea20, #764ba220); padding: 1.5rem; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 0.5rem;">üìÑ Document Classification</h4>
                        <p style="font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 0.5rem;">${results.document_type}</p>
                        <p style="color: #4a5568; font-size: 0.9rem;">This classification helps determine the relevant legal standards and typical provisions.</p>
                    </div>
                `;
            }

            // Display enhanced tip
            if (results.tip) {
                const tipContent = document.getElementById('tip-content');
                tipContent.innerHTML = `
                    <div style="background: linear-gradient(135deg, #10b98120, #059669); padding: 1.5rem; border-radius: 10px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 0.75rem;">üí° Expert Tip</h4>
                        <p style="color: #065f46; line-height: 1.6; font-weight: 500;">${results.tip}</p>
                    </div>
                `;
            }

            // Display enhanced key terms
            if (results.key_terms) {
                displayEnhancedKeyTerms(results.key_terms);
            }

            // Display enhanced risks
            if (results.risks) {
                displayEnhancedRisks(results.risks);
            }

            // Display important clauses
            if (results.important_clauses) {
                displayEnhancedClauses(results.important_clauses);
            }

            // Display enhanced timeline
            if (results.timeline) {
                displayEnhancedTimeline(results.timeline);
            }

            // Create enhanced visual representation
            createEnhancedVisualizations(results);

            // Scroll to results
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
            
            // Show success message
            showSuccessMessage();
        }

        function displayEnhancedSummary(summaryData) {
            const container = document.getElementById('summary-content');
            
            if (Array.isArray(summaryData)) {
                container.innerHTML = summaryData.map((point, index) => {
                    const pointData = typeof point === 'object' ? point : { description: point };
                    const categoryColors = {
                        financial: '#10b981',
                        benefits: '#8b5cf6', 
                        termination: '#ef4444',
                        obligations: '#f59e0b',
                        general: '#667eea'
                    };
                    const color = categoryColors[pointData.category] || categoryColors.general;
                    
                    return `
                        <div class="enhanced-summary-point">
                            <div class="point-header">
                                <div class="point-number" style="background: ${color};">${index + 1}</div>
                                <div>
                                    <h4>${pointData.title || `Key Point ${index + 1}`}</h4>
                                </div>
                            </div>
                            <div class="point-content">
                                <p>${pointData.description}</p>
                                ${pointData.example ? `
                                    <div class="example-box">
                                        <strong>Example:</strong> ${pointData.example}
                                    </div>
                                ` : ''}
                                ${pointData.impact ? `
                                    <div class="impact-box">
                                        <strong>Impact:</strong> ${pointData.impact}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="enhanced-summary-point">
                        <div class="point-header">
                            <div class="point-number">1</div>
                            <div><h4>Document Analysis</h4></div>
                        </div>
                        <div class="point-content">
                            <p>${summaryData}</p>
                        </div>
                    </div>
                `;
            }
        }

        function displayEnhancedKeyTerms(keyTerms) {
            const container = document.getElementById('key-terms-content');
            
            if (Array.isArray(keyTerms)) {
                container.innerHTML = `
                    <div class="key-terms-grid">
                        ${keyTerms.map(term => {
                            const termData = typeof term === 'object' ? term : { term: term, explanation: 'Important legal concept' };
                            return `
                                <div class="term-card">
                                    <div class="term-title">
                                        üîë ${termData.term}
                                        ${termData.importance ? `<span class="term-importance ${termData.importance}">${termData.importance}</span>` : ''}
                                    </div>
                                    <div class="term-explanation">${termData.explanation}</div>
                                    ${termData.example ? `
                                        <div class="example-box" style="margin-top: 0.75rem;">
                                            <strong>Example:</strong> ${termData.example}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `<p>${keyTerms}</p>`;
            }
        }

        function displayEnhancedRisks(risks) {
            const container = document.getElementById('risks-content');
            
            if (Array.isArray(risks)) {
                container.innerHTML = risks.map(risk => {
                    const riskData = typeof risk === 'object' ? risk : { title: 'Risk', description: risk };
                    const severity = riskData.severity || 'medium';
                    
                    return `
                        <div class="risk-item ${severity}-severity">
                            <div class="risk-header">
                                <div class="risk-title">‚ö†Ô∏è ${riskData.title}</div>
                                <div class="severity-badge ${severity}">${severity}</div>
                            </div>
                            <p style="color: #374151; margin-bottom: 0.75rem;">${riskData.description}</p>
                            ${riskData.impact ? `
                                <div style="background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                                    <strong style="color: #dc2626;">Impact:</strong> <span style="color: #374151;">${riskData.impact}</span>
                                </div>
                            ` : ''}
                            ${riskData.mitigation ? `
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: 6px;">
                                    <strong style="color: #10b981;">How to address:</strong> <span style="color: #374151;">${riskData.mitigation}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="risk-item medium-severity">
                        <div class="risk-header">
                            <div class="risk-title">‚ö†Ô∏è General Risk</div>
                            <div class="severity-badge medium">medium</div>
                        </div>
                        <p>${risks}</p>
                    </div>
                `;
            }
        }

        function displayEnhancedClauses(clauses) {
            const container = document.getElementById('important-clauses-content');
            
            if (Array.isArray(clauses)) {
                container.innerHTML = clauses.map(clause => `
                    <div style="background: linear-gradient(135deg, #fef3c7, #fed7aa); border-left: 4px solid #f59e0b; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4 style="color: #92400e; margin-bottom: 0.75rem;">üö® Important Clause</h4>
                        <p style="color: #451a03; line-height: 1.6;">${typeof clause === 'object' ? `<strong>${clause.title}:</strong> ${clause.description}` : clause}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fef3c7, #fed7aa); border-left: 4px solid #f59e0b; padding: 1.5rem; border-radius: 10px;">
                        <p style="color: #451a03;">${clauses}</p>
                    </div>
                `;
            }
        }

        function displayEnhancedTimeline(timeline) {
            const container = document.getElementById('timeline-content');
            
            if (Array.isArray(timeline)) {
                container.innerHTML = `
                    <div class="timeline-improved">
                        ${timeline.map((item, index) => {
                            const itemData = typeof item === 'object' ? item : { event: item };
                            const isLast = index === timeline.length - 1;
                            
                            return `
                                <div class="timeline-item-improved">
                                    ${!isLast ? '<div class="timeline-line"></div>' : ''}
                                    <div class="timeline-dot"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-date">üìÖ ${itemData.date || 'Important Date'}</div>
                                        <div class="timeline-event">${itemData.event}</div>
                                        ${itemData.action_required ? `
                                            <div class="timeline-action">
                                                <strong>Action needed:</strong> ${itemData.action_required}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="timeline-improved">
                        <div class="timeline-item-improved">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-event">${timeline}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function showSuccessMessage() {
            const successContainer = document.createElement('div');
            successContainer.className = 'success-container';
            successContainer.innerHTML = `
                <div class="success-header">
                    <div class="success-icon">‚úÖ</div>
                    <div style="color: #10b981; font-weight: bold; font-size: 1.1rem;">Analysis Complete!</div>
                </div>
                <div style="color: #065f46; margin-bottom: 1rem;">
                    Your document has been successfully analyzed. Review the insights below and use the voice feature to listen to the analysis.
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="voice-button" onclick="playAnalysis()" style="background: #10b981;">
                        üéµ Play Full Analysis
                    </button>
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">
                        Dismiss
                    </button>
                </div>
            `;
            
            // Insert at the top of results
            resultsContainer.querySelector('.card').insertBefore(successContainer, resultsContainer.querySelector('.card').firstChild);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (successContainer.parentNode) {
                    successContainer.remove();
                }
            }, 8000);
        }

        // Enhanced Visual Representations
        function createEnhancedVisualizations(results) {
            const container = document.getElementById('visual-content');
            container.innerHTML = '';

            // Create summary statistics
            const stats = generateAnalysisStatistics(results);
            
            container.innerHTML = `
                <div class="simple-chart">
                    <h4 style="text-align: center; margin-bottom: 1.5rem; color: #374151;">üìä Document Analysis Overview</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, #667eea20, #667eea10); border: 2px solid #667eea; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; color: #667eea; font-weight: bold;">${stats.summaryPoints}</div>
                            <div style="color: #4a5568; font-weight: 600;">Key Points</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Legal concepts explained</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #f59e0b20, #f59e0b10); border: 2px solid #f59e0b; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2.5rem; color: #f59e0b; font-weight: bold;">${stats.timelineCount}</div>
                            <div style="color: #4a5568; font-weight: 600;">Timeline Items</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">Important dates</div>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; border-radius: 12px; padding: 1.5rem; text-align: center;">
                        <h4 style="color: #374151; margin-bottom: 1rem;">üéØ Analysis Completeness</h4>
                        <div style="background: #e5e7eb; height: 12px; border-radius: 6px; overflow: hidden; margin: 1rem 0;">
                            <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: ${stats.completeness}%; border-radius: 6px; transition: width 1s ease;"></div>
                        </div>
                        <div style="color: #6b7280; font-size: 0.9rem;">
                            <strong>${stats.completeness}%</strong> of document elements analyzed
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAnalysisStatistics(results) {
            const stats = {
                summaryPoints: 0,
                riskCount: 0,
                termCount: 0,
                timelineCount: 0,
                completeness: 0
            };

            if (results.summary && Array.isArray(results.summary)) {
                stats.summaryPoints = results.summary.length;
            }

            if (results.risks && Array.isArray(results.risks)) {
                stats.riskCount = results.risks.length;
            }

            if (results.key_terms && Array.isArray(results.key_terms)) {
                stats.termCount = results.key_terms.length;
            }

            if (results.timeline && Array.isArray(results.timeline)) {
                stats.timelineCount = results.timeline.length;
            }

            // Calculate completeness based on available data
            const fields = ['summary', 'risks', 'key_terms', 'timeline', 'document_type', 'tip'];
            const completedFields = fields.filter(field => results[field] && results[field] !== '').length;
            stats.completeness = Math.round((completedFields / fields.length) * 100);

            return stats;
        }

        // Voice Feature Functions
        function playAnalysis() {
            if (!analysisResults) {
                showNotification('No analysis available to play', 'error');
                return;
            }

            if (!speechSynthesis) {
                showNotification('Speech synthesis not supported in this browser', 'error');
                return;
            }

            const section = currentSection;
            const language = document.getElementById('voice-language').value;
            const speed = parseFloat(document.getElementById('speed-slider').value);

            playSection(section, language, speed);
        }

        function playSection(section, language = 'en-US', speed = 1.0) {
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            currentSection = section;
            const text = formatAnalysisForSpeech(analysisResults, section);
            
            if (!text) {
                showNotification('No content available for this section', 'warning');
                return;
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = language;
            currentUtterance.rate = speed;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            // Set voice if available
            const voices = speechSynthesis.getVoices();
            const voice = voices.find(v => v.lang.startsWith(language.split('-')[0]));
            if (voice) {
                currentUtterance.voice = voice;
            }

            // Event handlers
            currentUtterance.onstart = () => {
                isPlaying = true;
                updateVoicePlayerUI();
                document.getElementById('play-btn').style.display = 'none';
                document.getElementById('pause-btn').style.display = 'inline-flex';
                floatingVoice.classList.add('listening');
            };

            currentUtterance.onend = () => {
                isPlaying = false;
                updateVoicePlayerUI();
                document.getElementById('play-btn').style.display = 'inline-flex';
                document.getElementById('pause-btn').style.display = 'none';
                floatingVoice.classList.remove('listening');
                document.getElementById('voice-current-section').textContent = 'Analysis complete';
            };

            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                showNotification('Voice playback failed. Please try again.', 'error');
                isPlaying = false;
                updateVoicePlayerUI();
            };

            // Update UI
            document.getElementById('voice-current-section').textContent = `Playing: ${getSectionName(section)}`;
            updateActiveSectionButton(section);

            // Start playback
            speechSynthesis.speak(currentUtterance);
        }

        function pauseAnalysis() {
            if (speechSynthesis && isPlaying) {
                speechSynthesis.pause();
                document.getElementById('play-btn').style.display = 'inline-flex';
                document.getElementById('pause-btn').style.display = 'none';
                document.getElementById('voice-current-section').textContent = 'Paused';
                floatingVoice.classList.remove('listening');
            }
        }

        function stopAnalysis() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
                isPlaying = false;
                updateVoicePlayerUI();
                document.getElementById('play-btn').style.display = 'inline-flex';
                document.getElementById('pause-btn').style.display = 'none';
                document.getElementById('voice-current-section').textContent = 'Ready to play analysis';
                floatingVoice.classList.remove('listening');
            }
        }

        function changeVoiceLanguage() {
            const language = document.getElementById('voice-language').value;
            if (isPlaying) {
                stopAnalysis();
                setTimeout(() => playSection(currentSection, language), 100);
            }
        }

        function changePlaybackSpeed(speed) {
            document.getElementById('speed-display').textContent = speed + 'x';
            if (isPlaying) {
                // Store current position and restart with new speed
                stopAnalysis();
                setTimeout(() => playSection(currentSection, document.getElementById('voice-language').value, parseFloat(speed)), 100);
            }
        }

        function formatAnalysisForSpeech(analysisData, section = 'all') {
            let speechParts = [];

            try {
                if (section === 'all' || section === 'summary') {
                    if (analysisData.summary && Array.isArray(analysisData.summary)) {
                        speechParts.push("Document Summary.");
                        analysisData.summary.forEach((item, index) => {
                            const point = typeof item === 'object' ? item : { description: item };
                            speechParts.push(`Point ${index + 1}: ${point.title || point.description}.`);
                            if (point.example) {
                                speechParts.push(`For example, ${point.example}.`);
                            }
                        });
                    }
                }

                if (section === 'all' || section === 'risks') {
                    if (analysisData.risks && Array.isArray(analysisData.risks)) {
                        speechParts.push("Risk Analysis.");
                        analysisData.risks.forEach(risk => {
                            const riskData = typeof risk === 'object' ? risk : { description: risk };
                            const severity = riskData.severity || 'medium';
                            speechParts.push(`${severity} severity risk: ${riskData.title || 'Risk'}. ${riskData.description}.`);
                            if (riskData.mitigation) {
                                speechParts.push(`To address this: ${riskData.mitigation}.`);
                            }
                        });
                    }
                }

                if (section === 'all' || section === 'timeline') {
                    if (analysisData.timeline && Array.isArray(analysisData.timeline)) {
                        speechParts.push("Important Dates and Timeline.");
                        analysisData.timeline.forEach(item => {
                            const timelineData = typeof item === 'object' ? item : { event: item };
                            speechParts.push(`${timelineData.date || 'Important date'}: ${timelineData.event}.`);
                            if (timelineData.action_required) {
                                speechParts.push(`Action required: ${timelineData.action_required}.`);
                            }
                        });
                    }
                }

                if (section === 'all' || section === 'terms') {
                    if (analysisData.key_terms && Array.isArray(analysisData.key_terms)) {
                        speechParts.push("Key Terms Explained.");
                        analysisData.key_terms.forEach(term => {
                            const termData = typeof term === 'object' ? term : { term: term };
                            speechParts.push(`${termData.term}: ${termData.explanation || 'Important legal concept'}.`);
                        });
                    }
                }

                if (analysisData.tip && section === 'all') {
                    speechParts.push(`Pro tip: ${analysisData.tip}`);
                }

                // Add disclaimer
                speechParts.push("Remember, this is general information and not legal advice. For specific legal matters, consult with a qualified attorney.");

            } catch (error) {
                console.error('Speech formatting error:', error);
                return "Analysis completed. Please review the document details on screen.";
            }

            return speechParts.join(" ");
        }

        function getSectionName(section) {
            const names = {
                'summary': 'Summary',
                'risks': 'Risks',
                'timeline': 'Timeline',
                'terms': 'Key Terms',
                'all': 'Full Analysis'
            };
            return names[section] || 'Analysis';
        }

        function updateActiveSectionButton(section) {
            document.querySelectorAll('.voice-section-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`[onclick*="${section}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function updateVoicePlayerUI() {
            // Update voice player UI based on current state
            if (isPlaying) {
                floatingVoice.classList.add('listening');
            } else {
                floatingVoice.classList.remove('listening');
            }
        }

        function speakText(text) {
            if (!speechSynthesis) {
                showNotification('Speech synthesis not supported', 'error');
                return;
            }

            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            speechSynthesis.speak(utterance);
        }

        function toggleVoiceWidget() {
            if (analysisResults) {
                playAnalysis();
            } else {
                showNotification('No analysis available to play. Upload a document or enter text first.', 'warning');
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const selectedContent = document.getElementById(`tab-${tabName}`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }

            // Add active class to selected tab
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
        }

        // Utility functions
        function showLoading(elementId, show) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = show ? 'block' : 'none';
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function changeLanguage() {
            const selectedLang = document.getElementById('language-select').value;
            currentLanguage = selectedLang;
            
            // Save to localStorage for persistence
            localStorage.setItem('preferred_language', selectedLang);
            
            // Update interface language
            updateInterfaceLanguage(selectedLang);
            
            // Update voice synthesis language
            if (document.getElementById('voice-language')) {
                document.getElementById('voice-language').value = SUPPORTED_LANGUAGES[selectedLang].voice;
            }
            
            showNotification(`Language changed to ${SUPPORTED_LANGUAGES[selectedLang].name}`, 'success');
        }

        function updateInterfaceLanguage(lang) {
            const translations = getUITranslations(lang);
            
            // Update placeholders and labels
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.placeholder = translations.chatPlaceholder;
            }
            
            const analyzeTextBtn = document.getElementById('analyze-text-btn');
            if (analyzeTextBtn) {
                analyzeTextBtn.textContent = translations.analyzeText;
            }
            
            const analyzeFileBtn = document.getElementById('analyze-file-btn');
            if (analyzeFileBtn && !analyzeFileBtn.disabled) {
                analyzeFileBtn.textContent = translations.analyzeDocument;
            }
        }

        function getUITranslations(lang) {
            const translations = {
                'en': {
                    chatPlaceholder: 'Ask about legal terms, clauses, or analysis results...',
                    analyzeText: 'Analyze Text',
                    analyzeDocument: 'Analyze Document'
                },
                'hi': {
                    chatPlaceholder: '‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§∂‡§¨‡•ç‡§¶‡•ã‡§Ç, ‡§ß‡§æ‡§∞‡§æ‡§ì‡§Ç ‡§Ø‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç...',
                    analyzeText: '‡§™‡§æ‡§† ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç',
                    analyzeDocument: '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç'
                },
                'ta': {
                    chatPlaceholder: '‡Æö‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æ§‡Æø‡ÆÆ‡ØÅ‡Æ±‡Øà‡Æï‡Æ≥‡Øç, ‡Æ™‡Æø‡Æ∞‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç...',
                    analyzeText: '‡Æâ‡Æ∞‡Øà‡ÆØ‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç',
                    analyzeDocument: '‡ÆÜ‡Æµ‡Æ£‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç'
                },
                'te': {
                    chatPlaceholder: '‡∞ö‡∞ü‡±ç‡∞ü‡∞™‡∞∞‡∞Æ‡±à‡∞® ‡∞®‡∞ø‡∞¨‡∞Ç‡∞ß‡∞®‡∞≤‡±Å, ‡∞®‡∞ø‡∞¨‡∞Ç‡∞ß‡∞®‡∞≤‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø...',
                    analyzeText: '‡∞µ‡∞ö‡∞®‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
                    analyzeDocument: '‡∞™‡∞§‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø'
                }
            };
            return translations[lang] || translations['en'];
        }

        // === 3. VOICE INPUT FUNCTIONS (add after existing functions) ===
        // Replace your existing speech recognition functions with these enhanced versions

        // === BROWSER COMPATIBILITY CHECK ===
        function checkBrowserSupport() {
            const support = {
                speechRecognition: false,
                speechSynthesis: false,
                browser: 'unknown'
            };
            
            // Detect browser
            const userAgent = navigator.userAgent.toLowerCase();
            if (userAgent.includes('chrome')) support.browser = 'Chrome';
            else if (userAgent.includes('firefox')) support.browser = 'Firefox';
            else if (userAgent.includes('safari')) support.browser = 'Safari';
            else if (userAgent.includes('edge')) support.browser = 'Edge';
            
            // Check speech recognition support
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                support.speechRecognition = true;
            }
            
            // Check speech synthesis support
            if ('speechSynthesis' in window) {
                support.speechSynthesis = true;
            }
            
            return support;
        }

        // === ENHANCED SPEECH RECOGNITION INITIALIZATION ===
        function initializeSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    console.warn('Speech recognition not supported');
                    return;
                }

                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                recognition.onresult = function(event) {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    
                    if (chatInput) {
                        chatInput.value = transcript;
                    }
                };

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceUI();
                };

                recognition.onend = function() {
                    isListening = false;
                    updateVoiceUI();
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    updateVoiceUI();
                };
            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
            }
        }

        function updateVoiceUI() {
            const voiceBtn = document.getElementById('voice-input-btn');
            const voiceStatus = document.getElementById('voice-status');
            
            if (!voiceBtn || !voiceStatus) return;
            
            if (isListening) {
                voiceBtn.classList.add('listening');
                voiceBtn.innerHTML = '‚èπÔ∏è';
                voiceStatus.style.display = 'block';
            } else {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = 'üé§';
                voiceStatus.style.display = 'none';
            }
        }
        // === SHOW VOICE NOT SUPPORTED MESSAGE ===
        function showVoiceNotSupported() {
            const voiceBtn = document.getElementById('voice-input-btn');
            if (voiceBtn) {
                voiceBtn.disabled = true;
                voiceBtn.innerHTML = 'üö´';
                voiceBtn.title = 'Voice input not supported in this browser. Try Chrome or Edge.';
                voiceBtn.style.opacity = '0.5';
            }
            
            // Show one-time notification
            if (!localStorage.getItem('voice_warning_shown')) {
                showNotification('Voice input requires Chrome or Edge browser. You can still use text input!', 'warning');
                localStorage.setItem('voice_warning_shown', 'true');
            }
        }

        // === ENHANCED TOGGLE VOICE INPUT ===
        function toggleVoiceInput() {
            const support = checkBrowserSupport();
            
            if (!support.speechRecognition) {
                showNotification('Voice input requires Chrome or Edge browser', 'error');
                return;
            }
            
            if (!isListening) {
                startVoiceInput();
            } else {
                stopVoiceInput();
            }
        }

        // === UPDATED START VOICE INPUT ===
        function startVoiceInput() {
            if (!recognition) {
                initializeSpeechRecognition();
            }
            
            if (recognition) {
                try {
                    recognition.lang = SUPPORTED_LANGUAGES[currentLanguage].code;
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start voice recognition:', error);
                    showNotification('Voice input failed to start. Please try again.', 'error');
                }
            } else {
                showNotification('Voice input not available in this browser', 'error');
            }
        }

        // === UPDATED STOP VOICE INPUT ===
        function stopVoiceInput() {
            if (recognition && isListening) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping voice recognition:', error);
                }
            }
            
            isListening = false;
            const voiceBtn = document.getElementById('voice-input-btn');
            const voiceStatus = document.getElementById('voice-status');
            
            if (voiceBtn) {
                voiceBtn.classList.remove('listening');
                voiceBtn.title = 'Voice Input';
            }
            if (voiceStatus) {
                voiceStatus.style.display = 'none';
            }
        }

        // === 4. ADMIN FUNCTIONS (add after existing functions) ===
        function showAdminLogin() {
            document.getElementById('admin-modal').style.display = 'block';
        }

        function closeAdminModal() {
            document.getElementById('admin-modal').style.display = 'none';
        }

        async function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            if (!username || !password) {
                showNotification('Please enter both username and password', 'error');
                return;
            }
            
            // Show loading state
            const loginBtn = document.querySelector('.admin-modal .btn');
            const originalText = loginBtn.textContent;
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;
            
            try {
                const response = await fetch('/api/admin-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    adminSessionToken = data.session_token;
                    adminSessionExpiry = new Date(data.expires);
                    
                    // Store session (encrypted in real app)
                    localStorage.setItem('admin_session', JSON.stringify({
                        token: adminSessionToken,
                        expires: adminSessionExpiry
                    }));
                    
                    closeAdminModal();
                    showNotification('Admin access granted! üîß', 'success');
                    
                    // Open admin panel
                    window.open('/admin', '_blank');
                    
                    // Clear form
                    document.getElementById('admin-username').value = '';
                    document.getElementById('admin-password').value = '';
                    
                } else {
                    showNotification(data.error || 'Invalid credentials', 'error');
                }
                
            } catch (error) {
                console.error('Admin login error:', error);
                showNotification('Login failed. Please check server connection.', 'error');
            } finally {
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
            }
        }

        // === CHECK EXISTING ADMIN SESSION ===
        function checkAdminSession() {
            const storedSession = localStorage.getItem('admin_session');
            if (storedSession) {
                try {
                    const session = JSON.parse(storedSession);
                    const expiry = new Date(session.expires);
                    
                    if (expiry > new Date()) {
                        adminSessionToken = session.token;
                        adminSessionExpiry = expiry;
                        return true;
                    } else {
                        localStorage.removeItem('admin_session');
                    }
                } catch (error) {
                    localStorage.removeItem('admin_session');
                }
            }
            return false;
        }

        // === VERIFY ADMIN SESSION WITH SERVER ===
        async function verifyAdminSession() {
            if (!adminSessionToken) return false;
            
            try {
                const response = await fetch('/api/admin-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_token: adminSessionToken })
                });
                
                const data = await response.json();
                return data.valid;
            } catch (error) {
                console.error('Admin session verification failed:', error);
                return false;
            }
        }

        // === ADMIN LOGOUT ===
        async function adminLogout() {
            if (adminSessionToken) {
                try {
                    await fetch('/api/admin-logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_token: adminSessionToken })
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            adminSessionToken = null;
            adminSessionExpiry = null;
            localStorage.removeItem('admin_session');
            showNotification('Logged out from admin panel', 'success');
        }

        // === PROTECTED ADMIN API CALLS ===
        async function makeAdminRequest(url, options = {}) {
            if (!adminSessionToken) {
                throw new Error('Admin authentication required');
            }
            
            // Verify session is still valid
            if (adminSessionExpiry && new Date() > adminSessionExpiry) {
                adminLogout();
                throw new Error('Admin session expired');
            }
            
            const headers = {
                ...options.headers,
                'Admin-Session-Token': adminSessionToken
            };
            
            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) {
                adminLogout();
                throw new Error('Admin session invalid');
            }
            
            return response;
        }
        // === UPDATE EXISTING ADMIN PANEL FUNCTIONS (for admin.html) ===

        // Update your admin panel's viewUsers function
        async function viewUsers() {
            try {
                const response = await makeAdminRequest('/admin/users');
                const data = await response.json();
                
                // ... rest of your existing viewUsers code stays the same ...
                
            } catch (error) {
                if (error.message.includes('authentication') || error.message.includes('session')) {
                    document.getElementById('database-content').innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: #fef2f2; border-radius: 15px; border: 2px solid #fecaca;">
                            <h3 style="color: #dc2626;">üîí Authentication Required</h3>
                            <p style="color: #666; margin: 1rem 0;">Your admin session has expired. Please log in again.</p>
                            <button class="btn" onclick="window.location.href='/'">Go to Login</button>
                        </div>
                    `;
                } else {
                    document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">‚ùå Error loading users: ${error.message}</p>`;
                }
            }
        }

        // Update your admin panel's viewAnalyses function
        async function viewAnalyses() {
            try {
                const response = await makeAdminRequest('/admin/analyses');
                const data = await response.json();
                
                // ... rest of your existing viewAnalyses code stays the same ...
                
            } catch (error) {
                if (error.message.includes('authentication') || error.message.includes('session')) {
                    document.getElementById('database-content').innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: #fef2f2; border-radius: 15px; border: 2px solid #fecaca;">
                            <h3 style="color: #dc2626;">üîí Authentication Required</h3>
                            <p style="color: #666; margin: 1rem 0;">Your admin session has expired. Please log in again.</p>
                            <button class="btn" onclick="window.location.href='/'">Go to Login</button>
                        </div>
                    `;
                } else {
                    document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">‚ùå Error loading analyses: ${error.message}</p>`;
                }
            }
        }


        function togglePasswordVisibility() {
            const passwordField = document.getElementById('admin-password');
            const toggleBtn = document.querySelector('.password-toggle');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordField.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        }
        // Enhanced error display function
        function showEnhancedError(errorType, details = null) {
            const error = ERROR_MESSAGES[errorType] || ERROR_MESSAGES['server_error'];
            
            const errorContainer = document.createElement('div');
            errorContainer.className = 'enhanced-error-container';
            errorContainer.innerHTML = `
                <div class="error-header">
                    <div class="error-icon">‚ùå</div>
                    <div class="error-title">${error.title}</div>
                    <button class="error-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
                <div class="error-message">
                    ${error.message}
                    ${details ? `<br><small style="opacity: 0.8;">Details: ${details}</small>` : ''}
                </div>
                <div class="error-suggestions">
                    <h4>üí° What you can do:</h4>
                    <ul>
                        ${error.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                    </ul>
                </div>
                <div class="error-actions">
                    <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">Dismiss</button>
                    <button class="btn" onclick="contactSupport('${errorType}')">Get Help</button>
                </div>
            `;
            
            // Add enhanced error styles
            errorContainer.style.cssText = `
                background: linear-gradient(135deg, #fef2f2, #fee2e2);
                border: 1px solid #fecaca;
                border-radius: 15px;
                padding: 1.5rem;
                margin: 1rem 0;
                box-shadow: 0 4px 20px rgba(220, 38, 38, 0.1);
                animation: slideInDown 0.4s ease;
            `;
            
            // Insert after the relevant section
            const targetElement = document.querySelector('.main-grid') || document.querySelector('.container');
            targetElement.appendChild(errorContainer);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (errorContainer.parentNode) {
                    errorContainer.style.animation = 'slideOutUp 0.4s ease';
                    setTimeout(() => errorContainer.remove(), 400);
                }
            }, 10000);
        }

        // Contact support function
        function contactSupport(errorType) {
            const supportInfo = `
            üõ†Ô∏è MyVakeel Support Information
            
            Error Type: ${errorType}
            Browser: ${navigator.userAgent}
            Time: ${new Date().toISOString()}
            
            üìß Email: support@myvakeel.com
            üí¨ Chat: Available on our website
            üì± Phone: +91-XXXX-XXXX (Mon-Fri, 9AM-6PM)
            
            üîß Quick Self-Help:
            1. Try refreshing the page
            2. Clear your browser cache
            3. Try in Chrome or Edge browser
            4. Check if your internet is stable
            `;
            
            alert(supportInfo);
        }

        // === ENHANCED NETWORK ERROR DETECTION ===
        function detectErrorType(error, response = null) {
            if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                return 'network_error';
            }
            
            if (response) {
                if (response.status >= 500) return 'server_error';
                if (response.status === 413) return 'file_too_large';
                if (response.status === 401) return 'login_required';
                if (response.status === 415) return 'invalid_file';
            }
            
            if (error.message.includes('File too large')) return 'file_too_large';
            if (error.message.includes('login') || error.message.includes('authentication')) return 'login_required';
            if (error.message.includes('file') || error.message.includes('format')) return 'invalid_file';
            
            return 'analysis_failed';
        }

        async function analyzeFileWithEnhancedErrors() {
            if (!currentUser) {
                showEnhancedError('login_required');
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                showNotification('Please select a file', 'error');
                return;
            }

            // Check file size before upload
            if (file.size > 10 * 1024 * 1024) {
                showEnhancedError('file_too_large', `Your file is ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            showUploadProgress();
            analyzeFileBtn.disabled = true;
            analyzeFileBtn.textContent = 'Analyzing...';

            try {
                const response = await fetch('/api/analyze-file', {
                    method: 'POST',
                    headers: { 'User-Email': currentUser.email },
                    body: formData
                });

                if (!response.ok) {
                    const errorType = detectErrorType(null, response);
                    const errorData = await response.json().catch(() => ({}));
                    showEnhancedError(errorType, errorData.details);
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    analysisResults = data.result;
                    displayEnhancedResults(data.result);
                    showNotification(`Document analyzed successfully! (${data.file_size})`, 'success');
                } else {
                    const errorType = detectErrorType(new Error(data.error));
                    showEnhancedError(errorType, data.details);
                }
            } catch (error) {
                console.error('File analysis error:', error);
                const errorType = detectErrorType(error);
                showEnhancedError(errorType, error.message);
            } finally {
                hideUploadProgress();
                analyzeFileBtn.disabled = false;
                analyzeFileBtn.textContent = 'Analyze Document';
            }
        }
        // Initialize speech synthesis on page load
        if (speechSynthesis) {
            speechSynthesis.onvoiceschanged = updateVoiceOptions;
        }
    </script>
</body>
</html>