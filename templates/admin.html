<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyVakeel - Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body style="background: linear-gradient(135deg, #2d3748, #4a5568);">
    <div class="admin-container">
        <div class="admin-header">
            <h1>ğŸ› ï¸ MyVakeel Admin Panel</h1>
            <p>Monitor your application and database activity</p>
            <div style="margin-top: 1rem;">
                <a href="/" class="btn" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2);">â† Back to App</a>
            </div>
        </div>

        <!-- System Status -->
        <div class="status-grid" id="status-grid">
            <div class="status-card">
                <h3>ğŸ–¥ï¸ Server</h3>
                <div id="server-status">Loading...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ”¥ Firebase</h3>
                <div id="firebase-status">Loading...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ’¾ Storage</h3>
                <div id="storage-status">Loading...</div>
            </div>
            <div class="status-card">
                <h3>ğŸ¤– AI Model</h3>
                <div id="ai-status">Loading...</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>âš¡ Quick Actions</h2>
            <div class="btn-group">
                <button class="btn" onclick="testDatabase()">ğŸ§ª Test Database</button>
                <button class="btn" onclick="createSampleData()">ğŸ“ Create Sample Data</button>
                <button class="btn" onclick="viewDatabase()">ğŸ‘ï¸ View Raw Data</button>
                <button class="btn" onclick="refreshAll()">ğŸ”„ Refresh All</button>
            </div>
            <div id="action-result"></div>
        </div>

        <!-- Database Viewer -->
        <div class="card">
            <h2>ğŸ—„ï¸ Database Contents</h2>
            <div class="btn-group">
                <button class="btn" onclick="viewUsers()">ğŸ‘¥ View Users</button>
                <button class="btn" onclick="viewAnalyses()">ğŸ“„ View Analyses</button>
                <button class="btn" onclick="viewStats()">ğŸ“Š Statistics</button>
            </div>
            <div id="database-content">
                <p style="text-align: center; color: #666; padding: 2rem;">
                    Select a view above to see database contents
                </p>
            </div>
        </div>
    </div>

    <script>
        // Auto-refresh every 30 seconds
        setInterval(refreshAll, 30000);
        
        // Load initial data
        document.addEventListener('DOMContentLoaded', refreshAll);

        async function refreshAll() {
            await checkSystemStatus();
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                document.getElementById('server-status').innerHTML = 
                    `<span class="status ${data.status === 'healthy' ? 'online' : 'offline'}">${data.status}</span>`;
                    
                document.getElementById('firebase-status').innerHTML = 
                    `<span class="status ${data.firebase_available ? 'online' : 'offline'}">
                        ${data.firebase_available ? 'Connected' : 'Offline'}
                    </span>`;
                    
                document.getElementById('storage-status').innerHTML = 
                    `<span class="status ${data.storage_available ? 'online' : 'offline'}">
                        ${data.storage_available ? 'Available' : 'Unavailable'}
                    </span>`;
                    
                document.getElementById('ai-status').innerHTML = 
                    `<span class="status ${data.ai_configured ? 'online' : 'offline'}">
                        ${data.ai_configured ? 'Configured' : 'Not Configured'}
                    </span>`;
                        
            } catch (error) {
                console.error('Status check failed:', error);
                document.getElementById('server-status').innerHTML = '<span class="status offline">Offline</span>';
                document.getElementById('firebase-status').innerHTML = '<span class="status offline">Unknown</span>';
                document.getElementById('storage-status').innerHTML = '<span class="status offline">Unknown</span>';
                document.getElementById('ai-status').innerHTML = '<span class="status offline">Unknown</span>';
            }
        }

        async function testDatabase() {
            const resultDiv = document.getElementById('action-result');
            resultDiv.innerHTML = '<p>ğŸ§ª Testing database connection...</p>';
            
            try {
                const response = await fetch('/api/test-db');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #f0fff4; border: 1px solid #48bb78; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <strong>âœ… Database Test Successful!</strong><br>
                            Project: ${data.firebase_project || 'Unknown'}<br>
                            Collections: ${data.collections_created.join(', ')}<br>
                            <small>Test user and sample analysis created successfully!</small>
                        </div>
                    `;
                    
                    // Auto-refresh users view after 1 second
                    setTimeout(viewUsers, 1000);
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #fff5f5; border: 1px solid #f56565; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <strong>âŒ Database Test Failed</strong><br>
                            ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #fff5f5; border: 1px solid #f56565; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <strong>âŒ Connection Failed</strong><br>
                        ${error.message}<br>
                        <small>Make sure Flask app is running on http://localhost:5000</small>
                    </div>
                `;
            }
        }

        async function createSampleData() {
            await testDatabase(); // This creates sample data
        }

        async function viewDatabase() {
            const resultDiv = document.getElementById('action-result');
            resultDiv.innerHTML = '<p>ğŸ‘ï¸ Loading raw database data...</p>';
            
            try {
                const response = await fetch('/api/view-db');
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color: #f56565;">âŒ ${data.error}</p>`;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div style="margin: 1rem 0;">
                        <h4>ğŸ—„ï¸ Raw Database Contents</h4>
                        <p><strong>Users:</strong> ${data.total_users} | <strong>Analyses:</strong> ${data.total_analyses}</p>
                        <div class="json-view">${JSON.stringify(data, null, 2)}</div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #f56565;">âŒ Error: ${error.message}</p>`;
            }
        }

        async function viewUsers() {
            try {
                const response = await fetch('/admin/users');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">âŒ ${data.error}</p>`;
                    return;
                }
                
                if (data.users.length === 0) {
                    document.getElementById('database-content').innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 15px;">
                            <h3 style="color: #667eea;">ğŸ‘¥ No Users Yet</h3>
                            <p style="color: #666; margin: 1rem 0;">Users will appear here when they log in to analyze documents.</p>
                            <button class="btn" onclick="testDatabase()">ğŸ§ª Create Test User</button>
                        </div>
                    `;
                    return;
                }
                
                const usersHtml = `
                    <div class="data-table">
                        <h3 style="padding: 1rem; margin: 0; background: #f8fafc;">ğŸ‘¥ Registered Users (${data.users.length})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Created At</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr>
                                        <td><strong>${user.email}</strong></td>
                                        <td>${user.created_at || 'N/A'}</td>
                                        <td>${user.last_login || 'N/A'}</td>
                                        <td>
                                            <span class="status ${user.test_user ? 'offline' : 'online'}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                ${user.test_user ? 'Test User' : 'Active'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('database-content').innerHTML = usersHtml;
            } catch (error) {
                document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">âŒ Error loading users: ${error.message}</p>`;
            }
        }

        async function viewAnalyses() {
            try {
                const response = await fetch('/admin/analyses');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">âŒ ${data.error}</p>`;
                    return;
                }
                
                if (data.analyses.length === 0) {
                    document.getElementById('database-content').innerHTML = `
                        <div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 15px;">
                            <h3 style="color: #667eea;">ğŸ“„ No Analyses Yet</h3>
                            <p style="color: #666; margin: 1rem 0;">Document analyses will appear here when users upload files.</p>
                            <div style="margin-top: 1.5rem;">
                                <p><strong>Try this:</strong></p>
                                <ol style="text-align: left; display: inline-block; margin: 1rem 0;">
                                    <li>Go to the <a href="/" style="color: #667eea;">main app</a></li>
                                    <li>Login with an email</li>
                                    <li>Upload a document or analyze text</li>
                                    <li>Come back here to see the results!</li>
                                </ol>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const analysesHtml = `
                    <div class="data-table">
                        <h3 style="padding: 1rem; margin: 0; background: #f8fafc;">ğŸ“„ Recent Analyses (${data.analyses.length})</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>File Name</th>
                                    <th>File Type</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.analyses.map(analysis => `
                                    <tr>
                                        <td>${analysis.user_email}</td>
                                        <td><strong>${analysis.file_name}</strong></td>
                                        <td>
                                            <span style="background: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                                ${analysis.file_type}
                                            </span>
                                        </td>
                                        <td>${analysis.created_at || 'N/A'}</td>
                                        <td>
                                            <button class="btn" onclick="viewAnalysisDetails('${analysis.doc_id}', ${JSON.stringify(analysis).replace(/"/g, '&quot;')})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                                ğŸ‘ï¸ View
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('database-content').innerHTML = analysesHtml;
            } catch (error) {
                document.getElementById('database-content').innerHTML = `<p style="color: #f56565;">âŒ Error loading analyses: ${error.message}</p>`;
            }
        }

        function viewAnalysisDetails(docId, analysisData) {
            const analysis = typeof analysisData === 'string' ? JSON.parse(analysisData) : analysisData;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 1000; padding: 2rem;
                overflow-y: auto; display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div style="padding: 2rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0;">ğŸ“„ Analysis Details</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #f56565; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">âœ• Close</button>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong>ğŸ“ File:</strong><br>${analysis.file_name}
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong>ğŸ‘¤ User:</strong><br>${analysis.user_email}
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong>ğŸ“… Date:</strong><br>${analysis.created_at || 'N/A'}
                            </div>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 8px;">
                                <strong>ğŸ“„ Type:</strong><br>${analysis.file_type}
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 1rem;">ğŸ¤– AI Analysis Results:</h3>
                        <div class="json-view" style="max-height: 400px;">${JSON.stringify(analysis.analysis_result, null, 2)}</div>
                        
                        ${analysis.storage_path ? `
                            <h3 style="margin: 1.5rem 0 1rem;">ğŸ“‚ Storage Information:</h3>
                            <p><strong>Storage Path:</strong> ${analysis.storage_path}</p>
                            ${analysis.public_url ? `<p><strong>Public URL:</strong> <a href="${analysis.public_url}" target="_blank" style="color: #667eea;">View File</a></p>` : ''}
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function viewStats() {
            // Generate statistics from current data
            const statsHtml = `
                <div style="text-align: center; padding: 3rem; background: #f8fafc; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 2rem;">ğŸ“Š Platform Statistics</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #667eea; font-weight: bold;" id="stat-users">-</div>
                            <div style="color: #666;">Total Users</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #48bb78; font-weight: bold;" id="stat-analyses">-</div>
                            <div style="color: #666;">Analyses</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="font-size: 2rem; color: #ed8936; font-weight: bold;">âˆ</div>
                            <div style="color: #666;">Chat Messages</div>
                        </div>
                    </div>
                    
                    <div style="text-align: left; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 1rem;">ğŸ“ˆ Quick Insights:</h4>
                        <ul style="color: #666; line-height: 1.6;">
                            <li>ğŸ’¬ <strong>Chat feature</strong> works without login - promoting accessibility</li>
                            <li>ğŸ“„ <strong>Document analysis</strong> requires email for data persistence</li>
                            <li>ğŸ”¥ <strong>Firebase integration</strong> enables real-time data storage</li>
                            <li>ğŸ¤– <strong>AI-powered insights</strong> using Google Gemini API</li>
                            <li>ğŸ¨ <strong>Visual representations</strong> make complex documents easier to understand</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <p style="color: #666; font-size: 0.9rem;">
                            Use "View Users" and "View Analyses" to see current platform activity
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('database-content').innerHTML = statsHtml;
            
            // Update stats with real data
            updateStats();
        }

        async function updateStats() {
            try {
                // Get users count
                const usersResponse = await fetch('/admin/users');
                const usersData = await usersResponse.json();
                document.getElementById('stat-users').textContent = usersData.users ? usersData.users.length : 0;
                
                // Get analyses count
                const analysesResponse = await fetch('/admin/analyses');
                const analysesData = await analysesResponse.json();
                document.getElementById('stat-analyses').textContent = analysesData.analyses ? analysesData.analyses.length : 0;
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
    </script>
</body>
</html>